<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparo de WhatsApp | by HAD Cloud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .instance-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-open { background-color: #28a745; }
        .status-closed { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; }
        
        .sending-progress {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            z-index: 1050;
        }
        
        .template-actions {
            display: none;
        }
        
        .list-group-item:hover .template-actions {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Modal de Alertas -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span id="alertIcon" class="me-2"></span>
                    <span id="alertTitle">Aviso</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="alertMessage" class="mb-0"></p>
            </div>
            <div class="modal-footer" id="alertFooter">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h2>Disparo de WhatsApp | by HAD Cloud</h2>
            </div>
        </div>

        <!-- Instance Selection -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Inst√¢ncia WhatsApp</h5>
                <button class="btn btn-sm btn-primary" onclick="loadInstances()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar Inst√¢ncias
                </button>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col">
                        <select class="form-select" id="instanceSelect">
                            <option value="">Selecione uma inst√¢ncia...</option>
                            {% for instance in instances %}
                            <option value="{{ instance.instance.instanceName }}">
                                {{ instance.instance.instanceName }}
                                {% if instance.instance.owner %}
                                    - {{ instance.instance.owner }}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div id="instanceStatus" class="alert alert-info" role="alert">
                    Selecione uma inst√¢ncia para ver o status
                </div>
            </div>
        </div>

        <!-- Numbers Input -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">N√∫meros para Envio</h5>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label for="numbersInput" class="form-label">Cole os n√∫meros (um por linha)</label>
                    <textarea class="form-control" id="numbersInput" rows="5" 
                        onpaste="handlePaste(event)" 
                        placeholder="Exemplo:&#10;+55 83 99999-9999&#10;+55 83 8888-8888"></textarea>
                </div>
                <button class="btn btn-primary" onclick="validateNumbers()">
                    <i class="bi bi-check-circle"></i> Validar N√∫meros
                </button>
            </div>
        </div>

        <!-- Validated Numbers -->
        <div class="card mb-4" id="validatedNumbersCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">N√∫meros Validados</h5>
            </div>
            <div class="card-body">
                <div id="validatedNumbers" class="mb-3"></div>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <label for="pageSize" class="form-label">Itens por p√°gina:</label>
                        <select class="form-select" id="pageSize" onchange="updateValidationResults()">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div id="pagination" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="previousPage()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span id="currentPage"></span> de <span id="totalPages"></span>
                        <button class="btn btn-sm btn-outline-primary ms-1" onclick="nextPage()">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Templates -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Templates de Mensagem</h5>
                <button class="btn btn-primary btn-sm" onclick="showAddTemplateModal()">
                    <i class="bi bi-plus-circle"></i> Novo Template
                </button>
            </div>
            <div class="card-body">
                <div class="list-group" id="messageTemplates">
                    {% for template in message_templates %}
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h6 class="mb-1">{{ template.name }}</h6>
                            <div class="template-actions">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editTemplate({{ template.id }})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate({{ template.id }})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="mb-1">{{ template.content }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sending Controls -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Controles de Envio</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Intervalo de Delay (segundos)</label>
                    <div class="row">
                        <div class="col">
                            <input type="number" class="form-control" id="minDelay" value="10" min="10">
                        </div>
                        <div class="col">
                            <input type="number" class="form-control" id="maxDelay" value="30" min="10">
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" id="sendButton" onclick="startSending()">Iniciar Envio</button>
            </div>
        </div>

        <!-- Sending History -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Hist√≥rico de Envios</h5>
                <button class="btn btn-danger btn-sm" onclick="clearHistory()">
                    <i class="bi bi-trash"></i> Limpar Hist√≥rico
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Inst√¢ncia</th>
                                <th>N√∫mero</th>
                                <th>Mensagem</th>
                                <th>Status</th>
                                <th>Delay</th>
                                <th>Tempo Total</th>
                            </tr>
                        </thead>
                        <tbody id="sendingHistory">
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <label for="historyPageSize" class="form-label">Itens por p√°gina:</label>
                        <select class="form-select" id="historyPageSize" onchange="updateHistoryDisplay()">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div id="historyPagination">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="previousHistoryPage()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span id="currentHistoryPage">1</span> de <span id="totalHistoryPages">1</span>
                        <button class="btn btn-sm btn-outline-primary ms-1" onclick="nextHistoryPage()">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateModalTitle">Adicionar Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="templateId">
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Nome do Template</label>
                        <input type="text" class="form-control" id="templateName">
                    </div>
                    <div class="mb-3">
                        <label for="templateContent" class="form-label">Conte√∫do da Mensagem</label>
                        <textarea class="form-control" id="templateContent" rows="5"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveTemplate()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Estat√≠sticas -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìä Estat√≠sticas do Envio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Enviado</h6>
                                    <h4 class="card-title" id="statsTotalSent">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Taxa de Sucesso</h6>
                                    <h4 class="card-title" id="statsSuccessRate">0%</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card text-white" id="statsSuccessCard">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2">Sucessos</h6>
                                    <h4 class="card-title" id="statsSuccess">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card text-white" id="statsErrorCard">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2">Falhas</h6>
                                    <h4 class="card-title" id="statsErrors">0</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="text-muted mb-3">Tempo</h6>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Tempo Total:</span>
                                        <strong id="statsTotalTime">-</strong>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>M√©dia por Mensagem:</span>
                                        <strong id="statsAvgTime">-</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sending Progress -->
    <div class="sending-progress" style="display: none;">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Progresso do Envio</h6>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100" 
                         style="width: 0%">
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                <div id="sendingStatus" class="small"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script>
        // Fun√ß√£o para mostrar alertas personalizados
        function showAlert(message, type = 'info', title = null, callback = null) {
            const modal = document.getElementById('alertModal');
            const iconSpan = document.getElementById('alertIcon');
            const titleSpan = document.getElementById('alertTitle');
            const messageP = document.getElementById('alertMessage');
            const footer = document.getElementById('alertFooter');
            
            // Define √≠cones e cores baseados no tipo
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è',
                'confirm': '‚ùì'
            };
            
            const titles = {
                'success': 'Sucesso',
                'error': 'Erro',
                'warning': 'Aten√ß√£o',
                'info': 'Aviso',
                'confirm': 'Confirma√ß√£o'
            };
            
            // Configura o modal
            iconSpan.textContent = icons[type] || icons.info;
            titleSpan.textContent = title || titles[type];
            messageP.textContent = message;
            
            // Configura os bot√µes
            if (type === 'confirm') {
                footer.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmBtn">Confirmar</button>
                `;
                
                // Adiciona evento ao bot√£o de confirmar
                document.getElementById('confirmBtn').onclick = () => {
                    bootstrap.Modal.getInstance(modal).hide();
                    if (callback) callback(true);
                };
            } else {
                footer.innerHTML = `
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                `;
            }
            
            // Mostra o modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Se n√£o for confirma√ß√£o, executa callback ap√≥s fechar
            if (type !== 'confirm') {
                modal.addEventListener('hidden.bs.modal', () => {
                    if (callback) callback();
                }, { once: true });
            }
        }

        // Socket.IO setup
        const socket = io();
        
        // Template Modal
        const templateModal = new bootstrap.Modal(document.getElementById('templateModal'));
        
        function showAddTemplateModal() {
            document.getElementById('templateId').value = '';
            document.getElementById('templateName').value = '';
            document.getElementById('templateContent').value = '';
            document.getElementById('templateModalTitle').textContent = 'Adicionar Template';
            
            const templateModal = new bootstrap.Modal(document.getElementById('templateModal'));
            templateModal.show();
        }

        function editTemplate(templateId) {
            fetch(`/get-template/${templateId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showAlert('Erro ao carregar template: ' + data.error, 'error');
                        return;
                    }
                    
                    document.getElementById('templateId').value = templateId;
                    document.getElementById('templateName').value = data.name;
                    document.getElementById('templateContent').value = data.content;
                    document.getElementById('templateModalTitle').textContent = 'Editar Template';
                    
                    const templateModal = new bootstrap.Modal(document.getElementById('templateModal'));
                    templateModal.show();
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showAlert('Erro ao carregar template. Tente novamente.', 'error');
                });
        }

        function saveTemplate() {
            const templateId = document.getElementById('templateId').value;
            const templateName = document.getElementById('templateName').value;
            const templateContent = document.getElementById('templateContent').value;

            if (!templateName || !templateContent) {
                showAlert('Por favor, preencha todos os campos.', 'warning');
                return;
            }

            const url = templateId ? `/update-template/${templateId}` : '/add-template';
            
            fetch(url, {
                method: templateId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: templateName,
                    content: templateContent
                }),
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    showAlert('Erro ao salvar template: ' + result.error, 'error');
                    return;
                }
                
                // Fecha o modal
                bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
                
                // Recarrega a lista de templates
                loadTemplates();
                
                // Mostra mensagem de sucesso
                showAlert('Template salvo com sucesso!', 'success');
            })
            .catch(error => {
                console.error('Erro:', error);
                showAlert('Erro ao salvar template. Tente novamente.', 'error');
            });
        }

        function deleteTemplate(templateId) {
            showAlert(
                'Tem certeza que deseja excluir este template?',
                'confirm',
                'Excluir Template',
                (confirmed) => {
                    if (confirmed) {
                        fetch(`/delete-template/${templateId}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                loadTemplates();
                                showAlert('Template exclu√≠do com sucesso!', 'success');
                            } else {
                                showAlert('Erro ao excluir template: ' + result.error, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao excluir template:', error);
                            showAlert('Erro ao excluir template. Tente novamente.', 'error');
                        });
                    }
                }
            );
        }

        // Vari√°veis globais para pagina√ß√£o
        let validationResults = [];
        let currentPage = 1;
        let pageSize = 5;  // Valor padr√£o inicial
        
        // Fun√ß√£o para atualizar a exibi√ß√£o dos resultados com pagina√ß√£o
        function updateValidationResults() {
            const validatedDiv = document.getElementById('validatedNumbers');
            pageSize = parseInt(document.getElementById('pageSize').value);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const paginatedResults = validationResults.slice(startIndex, endIndex);
            
            // Calcula o total de p√°ginas
            const totalPages = Math.ceil(validationResults.length / pageSize);
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('currentPage').textContent = currentPage;
            
            // Mostra ou esconde a pagina√ß√£o
            document.getElementById('pagination').style.display = 
                validationResults.length > pageSize ? 'flex' : 'none';

            // Cria o resumo da valida√ß√£o
            let html = `
                <div class="alert alert-info mb-3">
                    <strong>Resumo da Valida√ß√£o:</strong><br>
                    Total: ${validationResults.length} n√∫meros<br>
                    V√°lidos: ${validationResults.filter(r => r.valid).length} n√∫meros<br>
                    Inv√°lidos: ${validationResults.filter(r => !r.valid).length} n√∫meros<br>
                    Mostrando ${startIndex + 1} - ${Math.min(endIndex, validationResults.length)} de ${validationResults.length}
                </div>
                <div class="list-group">
            `;

            // Adiciona cada n√∫mero e seu resultado
            paginatedResults.forEach(result => {
                const badgeClass = result.valid ? 'bg-success' : 'bg-danger';
                const status = result.valid ? 'V√°lido' : 'Inv√°lido';
                const error = result.error ? `<br><small class="text-danger">${result.error}</small>` : '';
                const jid = result.jid ? `<br><small class="text-muted">JID: ${result.jid}</small>` : '';

                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${result.number}</strong>
                            ${jid}
                            ${error}
                        </div>
                        <span class="badge ${badgeClass}">${status}</span>
                    </div>
                `;
            });

            html += '</div>';
            validatedDiv.innerHTML = html;
        }

        // Fun√ß√£o para ir para a p√°gina anterior
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateValidationResults();
            }
        }

        // Fun√ß√£o para ir para a pr√≥xima p√°gina
        function nextPage() {
            const totalPages = Math.ceil(validationResults.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                updateValidationResults();
            }
        }

        // Fun√ß√£o para limpar e formatar n√∫meros
        function cleanPhoneNumber(number) {
            // Remove o cabe√ßalho 'phone' se existir
            if (number.toLowerCase().trim() === 'phone') return '';
            
            // Remove caracteres especiais, pontos e espa√ßos
            return number.replace(/[\+\-\s\(\)\.\,]/g, '')
                        .trim();
        }

        // Fun√ß√£o para processar os n√∫meros colados
        function handlePaste(event) {
            // Previne o comportamento padr√£o do paste
            event.preventDefault();
            
            // Pega o texto do clipboard
            const pastedText = event.clipboardData.getData('text');
            
            // Processa cada linha e remove duplicatas
            const lines = pastedText.split('\n');
            const processedLines = [...new Set(lines
                .map(line => cleanPhoneNumber(line))
                .filter(line => line.length > 0))]; // Remove linhas vazias e duplicatas
            
            // Atualiza o textarea com os n√∫meros processados
            event.target.value = processedLines.join('\n');
        }

        // Fun√ß√£o para carregar inst√¢ncias
        function loadInstances() {
            const statusDiv = document.getElementById('instanceStatus');
            const select = document.getElementById('instanceSelect');
            
            statusDiv.className = 'alert alert-info';
            statusDiv.textContent = 'Carregando inst√¢ncias...';
            
            fetch('/fetch-instances')
                .then(response => response.json())
                .then(data => {
                    select.innerHTML = '<option value="">Selecione uma inst√¢ncia...</option>';
                    
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            if (item.instance && item.instance.instanceName) {
                                const option = document.createElement('option');
                                option.value = item.instance.instanceName;
                                option.textContent = `${item.instance.instanceName}${item.instance.owner ? ` - ${item.instance.owner}` : ''}`;
                                select.appendChild(option);
                            }
                        });
                        
                        statusDiv.className = 'alert alert-success';
                        statusDiv.innerHTML = `${data.length} inst√¢ncia(s) encontrada(s)`;
                    } else {
                        statusDiv.className = 'alert alert-danger';
                        statusDiv.innerHTML = data.error || 'Erro ao carregar inst√¢ncias';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar inst√¢ncias:', error);
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.innerHTML = `Erro ao carregar inst√¢ncias: ${error}`;
                });
        }

        // Event listener para mudan√ßa de inst√¢ncia
        document.getElementById('instanceSelect').addEventListener('change', function() {
            const instanceName = this.value;
            const statusDiv = document.getElementById('instanceStatus');
            
            if (!instanceName) {
                statusDiv.className = 'alert alert-info';
                statusDiv.innerHTML = 'Selecione uma inst√¢ncia';
                return;
            }

            statusDiv.className = 'alert alert-info';
            statusDiv.innerHTML = 'Verificando status...';
            
            fetch(`/check-instance-status?instance=${encodeURIComponent(instanceName)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Status data:', data); // Debug

                    if (data.status === 'error') {
                        statusDiv.className = 'alert alert-danger';
                        statusDiv.innerHTML = `<div class="instance-status status-closed"></div> ${data.error}`;
                        return;
                    }

                    let statusClass, statusText;
                    switch (data.status) {
                        case 'CONNECTED':
                            statusClass = 'status-open';
                            statusText = 'Conectada';
                            break;
                        case 'CONNECTING':
                            statusClass = 'status-connecting';
                            statusText = 'Conectando';
                            break;
                        case 'DISCONNECTED':
                            statusClass = 'status-closed';
                            statusText = 'Desconectada';
                            break;
                        default:
                            statusClass = 'status-closed';
                            statusText = 'Status Desconhecido';
                    }

                    let statusHtml = `<div class="instance-status ${statusClass}"></div> ${instanceName} - ${statusText}`;
                    
                    if (data.details) {
                        if (data.details.owner) {
                            // Remove o @s.whatsapp.net do n√∫mero
                            const ownerNumber = data.details.owner.replace('@s.whatsapp.net', '');
                            statusHtml += `<br><small>N√∫mero: ${ownerNumber}</small>`;
                        }
                        if (data.details.profileName) {
                            statusHtml += `<br><small>Nome do Perfil: ${data.details.profileName}</small>`;
                        }
                        if (data.details.connectionState && data.details.instanceStatus) {
                            statusHtml += `<br><small>Estado da Conex√£o: ${data.details.connectionState}</small>`;
                            statusHtml += `<br><small>Status da Inst√¢ncia: ${data.details.instanceStatus}</small>`;
                        }
                    }

                    statusDiv.className = `alert alert-${data.status === 'CONNECTED' ? 'success' : data.status === 'CONNECTING' ? 'warning' : 'danger'}`;
                    statusDiv.innerHTML = statusHtml;
                })
                .catch(error => {
                    console.error('Erro ao verificar status:', error);
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.innerHTML = `<div class="instance-status status-closed"></div> Erro ao verificar status: ${error}`;
                });
        });

        // Fun√ß√£o para validar n√∫meros
        function validateNumbers() {
            const instanceName = document.getElementById('instanceSelect').value;
            if (!instanceName) {
                showAlert('Por favor, selecione uma inst√¢ncia.', 'error', 'Erro ao Validar N√∫meros');
                return;
            }

            const numbersText = document.getElementById('numbersInput').value;
            const numbers = numbersText.split('\n')
                .map(n => cleanPhoneNumber(n))
                .filter(n => n.length > 0);

            if (numbers.length === 0) {
                showAlert('Por favor, insira pelo menos um n√∫mero.', 'error', 'Erro ao Validar N√∫meros');
                return;
            }

            const validatedDiv = document.getElementById('validatedNumbers');
            const card = document.getElementById('validatedNumbersCard');
            
            validatedDiv.innerHTML = '<div class="alert alert-info">Validando n√∫meros...</div>';
            card.style.display = 'block';

            fetch('/validate-numbers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    numbers: numbers,
                    instance: instanceName
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    validatedDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                // Atualiza o textarea com os n√∫meros processados
                document.getElementById('numbersInput').value = numbers.join('\n');

                // Armazena os resultados e atualiza a exibi√ß√£o
                validationResults = data.results;
                currentPage = 1;
                updateValidationResults();
            })
            .catch(error => {
                console.error('Erro ao validar n√∫meros:', error);
                validatedDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Erro ao validar n√∫meros: ${error}
                    </div>
                `;
            });
        }

        // WebSocket event handlers
        socket.on('send_progress', function(data) {
            const progress = Math.round((data.current / data.total) * 100);
            const progressBar = document.querySelector('.sending-progress .progress-bar');
            const progressText = progressBar.querySelector('.progress-text');
            
            document.querySelector('.sending-progress').style.display = 'block';
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = `${progress}%`;
            
            // Formata o tempo decorrido
            const minutes = Math.floor(data.elapsed_time / 60);
            const seconds = data.elapsed_time % 60;
            const timeStr = minutes > 0 ? 
                `${minutes}min ${seconds}s` : 
                `${seconds}s`;
            
            document.getElementById('sendingStatus').innerHTML = 
                `Enviando ${data.current} de ${data.total} mensagens... (${data.number})<br>` +
                `Tempo decorrido: ${timeStr}`;
        });

        socket.on('send_result', function(data) {
            // Adiciona o novo resultado ao hist√≥rico
            const newResult = {
                sent_date: new Date().toLocaleString(),
                instance_name: document.getElementById('instanceSelect').value,
                number: data.number,
                message: document.querySelector('[data-template-id].active .template-content').textContent,
                status: data.status,
                error: data.error,
                delay: data.delay,
                total_time: data.total_time
            };
            
            // Atualiza o hist√≥rico e a exibi√ß√£o
            historyResults.unshift(newResult);
            updateHistoryDisplay();
        });

        socket.on('send_complete', function(data) {
            // Atualiza a barra de progresso para mostrar que est√° carregando as estat√≠sticas
            const progressBar = document.querySelector('.sending-progress .progress-bar');
            const sendingStatus = document.getElementById('sendingStatus');
            
            progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-info';
            progressBar.style.width = '100%';
            progressBar.setAttribute('aria-valuenow', 100);
            
            sendingStatus.innerHTML = '<i class="bi bi-graph-up"></i> Carregando estat√≠sticas, aguarde...';
            
            // Pequeno delay para mostrar a mensagem de carregamento antes de exibir o modal
            setTimeout(() => {
                try {
                    // Esconde a barra de progresso
                    document.querySelector('.sending-progress').style.display = 'none';
                    document.getElementById('sendButton').disabled = false;
                    
                    // Atualiza as estat√≠sticas no modal
                    document.getElementById('statsTotalSent').textContent = data.total_sent;
                    document.getElementById('statsSuccessRate').textContent = data.success_rate + '%';
                    document.getElementById('statsSuccess').textContent = data.success_count;
                    document.getElementById('statsErrors').textContent = data.error_count;
                    
                    // Atualiza as cores dos cards de sucesso/erro
                    const successCard = document.getElementById('statsSuccessCard');
                    const errorCard = document.getElementById('statsErrorCard');
                    
                    successCard.className = 'card text-white ' + 
                        (data.success_count > 0 ? 'bg-success' : 'bg-secondary');
                    errorCard.className = 'card text-white ' + 
                        (data.error_count > 0 ? 'bg-danger' : 'bg-secondary');
                    
                    // Formata e exibe os tempos
                    document.getElementById('statsTotalTime').textContent = formatTime(data.total_time);
                    document.getElementById('statsAvgTime').textContent = data.avg_time + 's';
                    
                    // Mostra o modal
                    const statsModal = new bootstrap.Modal(document.getElementById('statsModal'));
                    statsModal.show();
                } catch (error) {
                    console.error('Erro ao mostrar estat√≠sticas:', error);
                    showAlert(`Envio conclu√≠do! ${data.total_sent} mensagens enviadas em ${formatTime(data.total_time)}.`, 'success', 'Envio Conclu√≠do');
                    document.querySelector('.sending-progress').style.display = 'none';
                    document.getElementById('sendButton').disabled = false;
                }
            }, 1000); // Delay de 1 segundo para mostrar a mensagem de carregamento
        });

        socket.on('send_error', function(data) {
            console.error('Erro no envio:', data);
            showAlert(`Erro ao enviar para ${data.number}: ${data.error}`, 'error', 'Erro no Envio');
        });

        // Template selection
        document.getElementById('messageTemplates').addEventListener('click', function(e) {
            const item = e.target.closest('.list-group-item');
            if (item && !e.target.closest('.template-actions')) {
                document.querySelectorAll('[data-template-id]').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
            }
        });

        // Clear history
        function clearHistory() {
            showAlert(
                'Tem certeza que deseja limpar todo o hist√≥rico de envios?',
                'confirm',
                'Limpar Hist√≥rico',
                (confirmed) => {
                    if (confirmed) {
                        fetch('/clear-history', { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    historyResults = [];
                                    updateHistoryDisplay();
                                    showAlert('Hist√≥rico limpo com sucesso!', 'success', 'Hist√≥rico Limpo');
                                } else {
                                    showAlert('Erro ao limpar hist√≥rico: ' + data.error, 'error', 'Erro ao Limpar Hist√≥rico');
                                }
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                showAlert('Erro ao limpar hist√≥rico. Tente novamente.', 'error', 'Erro ao Limpar Hist√≥rico');
                            });
                    }
                }
            );
        }

        // Vari√°veis globais para pagina√ß√£o do hist√≥rico
        let historyResults = [];
        let historyCurrentPage = 1;
        let historyPageSize = 10;  // Valor padr√£o inicial
        
        // Fun√ß√£o para formatar o tempo em minutos e segundos
        function formatTime(seconds) {
            if (!seconds) return '-';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (minutes > 0) {
                return `${minutes}min ${remainingSeconds}s`;
            }
            return `${remainingSeconds}s`;
        }

        // Fun√ß√£o para atualizar a exibi√ß√£o do hist√≥rico com pagina√ß√£o
        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('sendingHistory');
            historyPageSize = parseInt(document.getElementById('historyPageSize').value);
            const startIndex = (historyCurrentPage - 1) * historyPageSize;
            const endIndex = startIndex + historyPageSize;
            const paginatedResults = historyResults.slice(startIndex, endIndex);
            
            // Calcula o total de p√°ginas
            const totalPages = Math.ceil(historyResults.length / historyPageSize);
            document.getElementById('totalHistoryPages').textContent = totalPages;
            document.getElementById('currentHistoryPage').textContent = historyCurrentPage;
            
            // Mostra ou esconde a pagina√ß√£o
            document.getElementById('historyPagination').style.display = 
                historyResults.length > historyPageSize ? 'flex' : 'none';

            // Cria o resumo do hist√≥rico
            let html = '';
            
            // Adiciona cada registro do hist√≥rico
            paginatedResults.forEach(result => {
                const badgeClass = result.status === 'success' ? 'bg-success' : 'bg-danger';
                const status = result.status === 'success' ? 'Sucesso' : 'Falha';
                const error = result.error ? `<br><small class="text-danger">${result.error}</small>` : '';

                html += `
                    <tr>
                        <td>${result.sent_date}</td>
                        <td>${result.instance_name}</td>
                        <td>${result.number}</td>
                        <td>${result.message}</td>
                        <td>
                            <span class="badge ${badgeClass}">${status}</span>
                            ${error}
                        </td>
                        <td>${result.delay}s</td>
                        <td>${formatTime(result.total_time)}</td>
                    </tr>
                `;
            });

            historyDiv.innerHTML = html;
        }

        // Fun√ß√£o para ir para a p√°gina anterior do hist√≥rico
        function previousHistoryPage() {
            if (historyCurrentPage > 1) {
                historyCurrentPage--;
                updateHistoryDisplay();
            }
        }

        // Fun√ß√£o para ir para a pr√≥xima p√°gina do hist√≥rico
        function nextHistoryPage() {
            const totalPages = Math.ceil(historyResults.length / historyPageSize);
            if (historyCurrentPage < totalPages) {
                historyCurrentPage++;
                updateHistoryDisplay();
            }
        }

        // Start sending messages
        function startSending() {
            const instanceName = document.getElementById('instanceSelect').value;
            if (!instanceName) {
                showAlert('Por favor, selecione uma inst√¢ncia.', 'error', 'Erro ao Iniciar Envio');
                return;
            }

            // Pega todos os n√∫meros v√°lidos da lista completa de valida√ß√£o
            const validNumbers = validationResults
                .filter(result => result.valid)
                .map(result => result.number);

            if (validNumbers.length === 0) {
                showAlert('Nenhum n√∫mero v√°lido para envio. Por favor, valide os n√∫meros primeiro.', 'error', 'Erro ao Iniciar Envio');
                return;
            }

            const activeTemplate = document.querySelector('[data-template-id].active');
            if (!activeTemplate) {
                showAlert('Por favor, selecione um template de mensagem.', 'error', 'Erro ao Iniciar Envio');
                return;
            }

            const templateId = activeTemplate.dataset.templateId;
            const minDelay = parseInt(document.getElementById('minDelay').value);
            const maxDelay = parseInt(document.getElementById('maxDelay').value);

            if (minDelay > maxDelay) {
                showAlert('O delay m√≠nimo deve ser menor que o m√°ximo.', 'error', 'Erro ao Iniciar Envio');
                return;
            }

            if (!confirm(`Deseja enviar a mensagem para ${validNumbers.length} n√∫meros?`)) {
                return;
            }

            // Reset progress
            document.querySelector('.progress-bar').style.width = '0%';
            document.querySelector('.progress-bar').textContent = '0%';
            document.querySelector('.sending-progress').style.display = 'block';
            document.getElementById('sendButton').disabled = true;

            // Envia a requisi√ß√£o
            fetch('/send-messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    instance: instanceName,
                    numbers: validNumbers,
                    template_id: templateId,
                    delay_range: [minDelay, maxDelay]
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert('Erro ao iniciar envio: ' + data.error, 'error', 'Erro ao Iniciar Envio');
                    document.getElementById('sendButton').disabled = false;
                    document.querySelector('.sending-progress').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showAlert('Erro ao iniciar envio. Tente novamente.', 'error', 'Erro ao Iniciar Envio');
                document.getElementById('sendButton').disabled = false;
                document.querySelector('.sending-progress').style.display = 'none';
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadInstances();
            loadTemplates();
            
            fetch('/get-history')
            .then(response => response.json())
            .then(data => {
                historyResults = data;
                updateHistoryDisplay();
            })
            .catch(error => {
                console.error('Erro ao carregar hist√≥rico:', error);
                showAlert('Erro ao carregar hist√≥rico', 'error', 'Erro ao Carregar Hist√≥rico');
            });
        });

        function loadTemplates() {
            fetch('/list-templates')
            .then(response => response.json())
            .then(templates => {
                const container = document.getElementById('messageTemplates');
                container.innerHTML = templates.map(template => `
                    <div class="list-group-item list-group-item-action" data-template-id="${template.id}">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div class="template-content">
                                <h6 class="mb-1">${template.name || ''}</h6>
                                <p class="mb-1">${template.content || ''}</p>
                            </div>
                            <div class="template-actions">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editTemplate(${template.id})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate(${template.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => {
                console.error('Erro ao carregar templates:', error);
                showAlert('Erro ao carregar templates', 'error');
            });
        }
    </script>
</body>
</html>
